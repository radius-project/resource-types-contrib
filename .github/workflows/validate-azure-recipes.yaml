name: Validate Azure Recipes

on:
  push:
    branches: [ main ]
    paths:
      - '**/azure/**'
      - '**/test/app.bicep'
      - '.github/workflows/validate-azure-recipes.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - '**/azure/**'
      - '**/test/app.bicep'
      - '.github/workflows/validate-azure-recipes.yaml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Radius version number to use (e.g. 0.51.0, 0.51.0-rc1, edge).'
        required: false
        default: 'edge'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  validate-azure-recipes:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    name: Validate Azure ${{ matrix.recipe }} Recipes
    environment: azure
    strategy:
      fail-fast: false
      matrix:
        recipe: [bicep, terraform]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Azure Login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Azure Test Context
        id: set-context
        run: |
          LOCATION="${AZURE_LOCATION:-${{ vars.AZURE_LOCATION }}}"
          if [ -z "$LOCATION" ]; then
            LOCATION="westus3"
          fi
          RG="rrttest-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.recipe }}"
          echo "location=$LOCATION" >> "$GITHUB_OUTPUT"
          echo "AZURE_LOCATION=$LOCATION" >> "$GITHUB_ENV"
          echo "AZURE_RESOURCE_GROUP=$RG" >> "$GITHUB_ENV"
          echo "AZURE_WORKSPACE_NAME=default" >> "$GITHUB_ENV"
          echo "AZURE_ENVIRONMENT_NAME=default" >> "$GITHUB_ENV"

      - name: Create Azure Resource Group
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail
          RG="${{ env.AZURE_RESOURCE_GROUP }}"
          LOCATION="${{ env.AZURE_LOCATION }}"
          current_time=$(date +%s)
          az group create \
            --only-show-errors \
            --output none \
            --location "$LOCATION" \
            --name "$RG" \
            --subscription "$AZURE_SUBSCRIPTION_ID" \
            --tags creationTime=$current_time > /dev/null
          # Wait for resource group to be fully available
          while [[ "$(az group exists --name "$RG" --subscription "$AZURE_SUBSCRIPTION_ID")" != "true" ]]; do
            echo "Waiting for resource group '$RG' to be available..."
            sleep 5
          done
          echo "Resource group '$RG' is ready"

      - name: Setup Node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 22

      - name: Set up ORAS
        uses: oras-project/setup-oras@22ce207df3b08e061f537244349aac6ae1d214f6 # v1.2.0
        with:
          version: '1.2.0'

      - name: Install Radius CLI
        run: make install-radius-cli RAD_VERSION="${{ inputs.version || 'edge' }}"

      - name: Create Radius Cluster
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TEST_AZURE_OIDC_JSON: ${{ secrets.TEST_AZURE_OIDC_JSON }}
        run: make create-radius-cluster

      - name: Configure Azure Provider
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: make configure-azure-provider

      - name: Build Azure Recipes
        run: make build-azure-recipes

      - name: Generate Azure Recipe Pack
        run: RECIPE_PLATFORM_FILTER=azure make generate-recipe-pack PACK_NAME=azure${{ matrix.recipe }}recipepack OUTPUT_FILE=recipe-pack-azure-${{ matrix.recipe }}.bicep

      - name: Deploy Azure Recipe Pack
        env:
          RESOURCE_GROUP: ${{ env.AZURE_RESOURCE_GROUP }}
          SUBSCRIPTION: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: make deploy-recipe-pack BICEP_FILE=recipe-pack-azure-${{ matrix.recipe }}.bicep

      - name: Update Azure Environment with Recipe Pack
        run: make update-env-recipe-pack RECIPE_PACK_NAME=azure${{ matrix.recipe }}recipepack ENVIRONMENT=${{ env.AZURE_ENVIRONMENT_NAME }}

      - name: Test Azure ${{ matrix.recipe }} Recipes
        run: RECIPE_PLATFORM_FILTER=azure make test ENVIRONMENT=${{ env.AZURE_ENVIRONMENT_NAME }} RECIPE_TYPE=${{ matrix.recipe }}

      - name: Collect Radius pod logs
        if: always()
        run: |
          mkdir -p radius-pod-logs
          APP_POD=$(kubectl get pods -n radius-system -o json | jq -r '.items[] | select(.metadata.name | startswith("applications-rp-")) | .metadata.name' | head -n1)
          if [ -n "$APP_POD" ]; then
            kubectl logs "$APP_POD" -n radius-system --all-containers > radius-pod-logs/applications-rp.log || true
          else
            echo "applications-rp pod not found" > radius-pod-logs/applications-rp.log
          fi
          DE_POD=$(kubectl get pods -n radius-system -o json | jq -r '.items[] | select(.metadata.name | test("^(deployment-engine|bicep-de)-")) | .metadata.name' | head -n1)
          if [ -n "$DE_POD" ]; then
            kubectl logs "$DE_POD" -n radius-system --all-containers > radius-pod-logs/deployment-engine.log || true
          else
            echo "deployment engine pod not found" > radius-pod-logs/deployment-engine.log
          fi

      - name: Upload Radius pod logs
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: radius-pod-logs-${{ matrix.recipe }}
          path: radius-pod-logs
          if-no-files-found: warn

      - name: Cleanup Azure Resources
        if: always()
        run: make cleanup-azure-resources
